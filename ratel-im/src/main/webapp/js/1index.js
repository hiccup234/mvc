var userName="";var websocketUrl;(function($){$("#send").on("click",function(){sendContent()});getUserName()})(window.Zepto);function apendUser(userName){var appendHtml='<li id="'+userName+'">'+'<div class="am-cf">'+"<a >&nbsp;&nbsp;&nbsp;"+userName+"</a>"+'<button class="am-btn am-btn-success am-btn-xs am-fr" onclick="connectTo(\''+userName+"')\">通话</button>"+"</div>"+"</li>";$("#user-list").append(appendHtml)}function getToken(){return Math.round(Math.random()*9999999999)+9999999999}function openNewWindow(owurl){var tmp=window.open("about:blank","","");tmp.top.location=owurl}function connectTo(oneOnlineUser){var roomId=getToken();webSocket.send(JSON.stringify({"type":"connect","roomId":roomId,"userName":oneOnlineUser}));openNewWindow("webrtc.html?roomId="+roomId)}function removeUser(liId){$("#"+liId+"").remove()}var showChatDetail=document.getElementById("show-chat");function sendContent(){var contentVal=$("#content").val().trim();if(contentVal==null||contentVal==""){showTips("请输入内容");return}var timeString=new Date().Format("yyyy-MM-dd hh:mm:ss");webSocket.send(JSON.stringify({"type":"message","contentVal":contentVal}));$("#content").val("")}function appendChat(userName,chatVal,timeString){var appendHtml="<div>"+'<span class="am-badge am-badge-secondary am-radius">'+userName+"</span>说:"+chatVal+'<span class="am-badge am-radius">------------'+timeString+"</span>"+"<hr></div>";$("#show-chat").append(appendHtml);showChatDetail.scrollTop=100000}function showTips(tipContent){$("#tip-content").html(tipContent);$("#my-tip").modal({relatedElement:this});setTimeout('$("#my-tip").modal("close")',1000)}function getUserName(){$("#my-prompt").modal({relatedElement:this,cancelable:false,onConfirm:function(data){data=data.trim();if(data==null||data==""){setTimeout("getUserName()",300)}else{userName=data;websocketUrl=chatWebSocketUrl+"?user="+userName;startWebSocket()}}})}function isChineseOrEnglish(str){var reg=/^\w+$/;return reg.test(str)}var webSocket=null;function startWebSocket(){if("WebSocket" in window){try{webSocket=new WebSocket(websocketUrl)}catch(e){console.log(e)}}else{if("MozWebSocket" in window){webSocket=new MozWebSocket(websocketUrl)}else{console.log("not support")}}webSocket.onmessage=function(returnMessage){console.log(returnMessage);var message=JSON.parse(returnMessage.data);console.log(message.type);if(message.type=="message"){var timeString=new Date().Format("yyyy-MM-dd hh:mm:ss");appendChat(message.user,message.msg,timeString)}else{if(message.type=="user_is_contain"){console.log("用户名已存在");webSocket.close();$("#prompt-tips").html("用户名已存在");setTimeout("getUserName()",300)}else{if(message.type=="get_online_user"){var users=message.list;for(var i=0;i<users.length;i++){if(users[i]==userName){var appendHtml='<li id="'+userName+'">'+'<div class="am-cf">'+"<a >&nbsp;&nbsp;&nbsp;"+userName+"</a>(me)"+"</div>"+"</li>";$("#user-list").append(appendHtml)}else{apendUser(users[i])}}}else{if(message.type=="user_join"){var user=message.user;apendUser(user)}else{if(message.type=="user_leave"){var user=message.user;removeUser(user)}else{if(message.type=="connect"){$("#connect-name").html('<span class="am-badge am-badge-secondary am-radius">'+message.userName+"</span>正在请求与您视频通话");$("#my-connect").modal({relatedElement:this,cancelable:true,onConfirm:function(data){openNewWindow("webrtc.html?roomId="+message.roomId)}})}}}}}}};webSocket.onclose=function(evt){console.log("close!");alert("连接已断开，请重新登录");window.location.reload()};webSocket.onopen=function(evt){console.log("open")}};